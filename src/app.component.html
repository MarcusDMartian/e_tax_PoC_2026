
<div class="min-h-screen bg-[#F4F4F4] font-['Be_Vietnam_Pro'] relative overflow-hidden flex flex-row transition-all duration-500">
  
  <!-- Notifications -->
  <div class="fixed top-8 right-8 z-[100] space-y-3 pointer-events-none">
    @for (n of notifications(); track n.id) {
      <div class="pointer-events-auto p-4 rounded-2xl shadow-2xl border flex items-center gap-4 animate-in min-w-[300px]"
           [class.bg-green-600]="n.type === 'success'" [class.text-white]="n.type === 'success'"
           [class.bg-black]="n.type === 'info'" [class.text-white]="n.type === 'info'">
        <span class="material-icons">{{ n.type === 'success' ? 'check_circle' : 'info' }}</span>
        <p class="text-[11px] font-black uppercase tracking-widest">{{ n.message }}</p>
      </div>
    }
  </div>

  <!-- 1. SIDEBAR -->
  <aside class="w-72 h-screen sticky top-0 bg-white border-r border-black/5 shadow-xl flex flex-col p-8 z-50 shrink-0">
    <div class="flex items-center gap-3 mb-12">
      <div class="w-10 h-10 bg-black text-[#97C2EC] rounded-xl flex items-center justify-center shadow-lg"><span class="material-icons !text-xl">hub</span></div>
      <div>
        <h1 class="text-lg font-black tracking-tighter uppercase leading-none text-black">E-TAX HKD</h1>
        <p class="text-[8px] font-bold text-black/40 uppercase tracking-widest mt-1">v2.4 Build 2026</p>
      </div>
    </div>
    
    <nav class="flex-1 flex flex-col gap-1 overflow-y-auto no-scrollbar">
      <button (click)="selectTab('calc')" [class]="activeTab() === 'calc' ? 'bg-black text-white shadow-lg' : 'text-black/40 hover:bg-black/5'" class="w-full px-5 py-3.5 rounded-xl text-[10px] font-black uppercase tracking-widest transition-all text-left flex items-center gap-3"><span class="material-icons !text-[18px]">analytics</span> Báo Cáo</button>
      <button (click)="selectTab('declare')" [class]="activeTab() === 'declare' ? 'bg-black text-white shadow-lg' : 'text-black/40 hover:bg-black/5'" class="w-full px-5 py-3.5 rounded-xl text-[10px] font-black uppercase tracking-widest transition-all text-left flex items-center gap-3"><span class="material-icons !text-[18px]">assignment</span> Kê Khai</button>
      <button (click)="selectTab('invoices')" [class]="activeTab() === 'invoices' ? 'bg-black text-white shadow-lg' : 'text-black/40 hover:bg-black/5'" class="w-full px-5 py-3.5 rounded-xl text-[10px] font-black uppercase tracking-widest transition-all text-left flex items-center gap-3"><span class="material-icons !text-[18px]">receipt_long</span> Hóa Đơn</button>
      
      <div class="flex flex-col">
        <button (click)="toggleSubMenu('integration', $event)" [class.text-black]="isParentActive('integration')" class="w-full px-5 py-3.5 rounded-xl text-[10px] font-black uppercase tracking-widest transition-all text-left flex items-center justify-between group text-black/40 hover:bg-black/5">
          <div class="flex items-center gap-3"><span class="material-icons !text-[18px]">extension</span><span>Cổng tích hợp</span></div>
          <span class="material-icons !text-xs transition-transform" [class.rotate-90]="expandedMenus()['integration']">chevron_right</span>
        </button>
        @if (expandedMenus()['integration']) {
          <div class="pl-12 flex flex-col gap-1 mt-1 animate-in">
            <button (click)="selectTab('integration-pos')" [class.text-black]="activeTab() === 'integration-pos'" class="py-2.5 text-[10px] font-black uppercase tracking-widest opacity-40 hover:opacity-100 transition-all text-left flex items-center gap-2">
              <span>Máy bán hàng</span>
              @if (posStatus()['Sapo'] === 'connected') { <div class="w-1.5 h-1.5 rounded-full bg-green-500"></div> }
            </button>
            <button (click)="selectTab('integration-sign')" [class.text-black]="activeTab() === 'integration-sign'" class="py-2.5 text-[10px] font-black uppercase tracking-widest opacity-40 hover:opacity-100 transition-all text-left">Chữ ký & Hóa đơn</button>
            <button (click)="selectTab('integration-tax')" [class.text-black]="activeTab() === 'integration-tax'" class="py-2.5 text-[10px] font-black uppercase tracking-widest opacity-40 hover:opacity-100 transition-all text-left">Chi cục Thuế</button>
          </div>
        }
      </div>

      <div class="flex flex-col">
        <button (click)="toggleSubMenu('tools', $event)" [class.text-black]="isParentActive('tools')" class="w-full px-5 py-3.5 rounded-xl text-[10px] font-black uppercase tracking-widest transition-all text-left flex items-center justify-between group text-black/40 hover:bg-black/5">
          <div class="flex items-center gap-3"><span class="material-icons !text-[18px]">construction</span><span>Công cụ</span></div>
          <span class="material-icons !text-xs transition-transform" [class.rotate-90]="expandedMenus()['tools']">chevron_right</span>
        </button>
        @if (expandedMenus()['tools']) {
          <div class="pl-12 flex flex-col gap-1 mt-1 animate-in">
            <button (click)="selectTab('quick-calc')" [class.text-black]="activeTab() === 'quick-calc'" class="py-2.5 text-[10px] font-black uppercase tracking-widest opacity-40 hover:opacity-100 transition-all text-left">Tính Thuế</button>
            <button (click)="selectTab('penalty')" [class.text-black]="activeTab() === 'penalty'" class="py-2.5 text-[10px] font-black uppercase tracking-widest opacity-40 hover:opacity-100 transition-all text-left">Vi Phạm</button>
          </div>
        }
      </div>

      <div class="flex flex-col">
        <button (click)="toggleSubMenu('accounting', $event)" [class.text-black]="isParentActive('accounting')" class="w-full px-5 py-3.5 rounded-xl text-[10px] font-black uppercase tracking-widest transition-all text-left flex items-center justify-between group text-black/40 hover:bg-black/5">
          <div class="flex items-center gap-3"><span class="material-icons !text-[18px]">account_balance</span><span>Kế toán</span></div>
          <span class="material-icons !text-xs transition-transform" [class.rotate-90]="expandedMenus()['accounting']">chevron_right</span>
        </button>
        @if (expandedMenus()['accounting']) {
          <div class="pl-12 flex flex-col gap-1 mt-1 animate-in">
            <button (click)="selectTab('accounting-book')" [class.text-black]="activeTab() === 'accounting-book'" class="py-2.5 text-[10px] font-black uppercase tracking-widest opacity-40 hover:opacity-100 transition-all text-left">Sổ Kế Toán</button>
          </div>
        }
      </div>

      <button (click)="selectTab('guide')" [class]="activeTab() === 'guide' ? 'bg-black text-white shadow-lg' : 'text-black/40 hover:bg-black/5'" class="w-full px-5 py-3.5 rounded-xl text-[10px] font-black uppercase tracking-widest transition-all text-left flex items-center gap-3"><span class="material-icons !text-[18px]">help_outline</span> Hướng Dẫn</button>
    </nav>
  </aside>

  <!-- 2. CONTENT WRAPPER -->
  <div class="flex-1 flex flex-col h-screen overflow-y-auto relative bg-[#F4F4F4]">
    <header class="w-full py-8 px-4 z-40 bg-white/50 backdrop-blur shrink-0 border-b border-black/5">
      <div class="w-full max-w-[1200px] mx-auto flex justify-between items-center">
        <div class="flex items-center gap-4">
          <div class="w-12 h-12 bg-black text-[#97C2EC] rounded-xl flex items-center justify-center shadow-xl"><span class="material-icons text-3xl">hub</span></div>
          <div>
            <h1 class="text-2xl font-black tracking-tighter uppercase leading-none">Vietnam E-TAX HKD 2026</h1>
            <p class="text-[9px] font-bold text-black/40 uppercase tracking-widest mt-1">Hệ thống đồng bộ dữ liệu thông minh</p>
          </div>
        </div>
        <div class="flex items-center gap-3 bg-black text-white px-5 py-2.5 rounded-2xl text-[9px] font-black uppercase tracking-widest">
           <span class="w-2 h-2 rounded-full bg-green-500 animate-pulse"></span>
           Gateway Connect: Stable
        </div>
      </div>
    </header>

    <main class="flex-1 w-full flex flex-col items-center py-8 px-4 md:px-8 z-10">
      <div class="w-full max-w-[1200px] flex flex-col gap-8">
        
        <!-- MODULE: BÁO CÁO -->
        @if (activeTab() === 'calc') {
          <div class="animate-in bg-white rounded-[48px] shadow-2xl p-12">
            <h2 class="text-3xl font-black uppercase mb-10 tracking-tight">Thống kê Doanh thu & Thuế</h2>
            <div #chartContainer class="w-full h-[350px]"></div>
          </div>
        }

        <!-- MODULE: KÊ KHAI (NÂNG CẤP) -->
        @if (activeTab() === 'declare') {
          <div class="animate-in bg-white rounded-[48px] shadow-2xl p-12 min-h-[700px]">
            @if (!isDeclaring()) {
              <div class="flex justify-between items-center mb-12">
                <div>
                  <h2 class="text-3xl font-black uppercase tracking-tight mb-2">Quản Lý Tờ Khai 01/CNKD</h2>
                  <p class="text-black/40 text-sm font-medium uppercase tracking-tight">Lập tờ khai thuế khoán, thuế kê khai hàng quý/tháng theo Thông tư 40/2021/TT-BTC</p>
                </div>
                <button (click)="startDeclaration()" class="bg-black text-white px-8 py-4 rounded-2xl font-black uppercase text-[10px] tracking-widest shadow-xl flex items-center gap-2">
                  <span class="material-icons">add_task</span> Lập Tờ Khai Mới
                </button>
              </div>
              <div class="bg-gray-50/50 rounded-[40px] border border-black/5 overflow-hidden">
                <table class="w-full text-left">
                  <thead class="bg-black text-white text-[9px] font-black uppercase tracking-widest">
                    <tr><th class="p-6">Kỳ Kê Khai</th><th class="p-6">Loại Tờ Khai</th><th class="p-6">Hạn Nộp</th><th class="p-6 text-right">Thuế Phải Nộp</th><th class="p-6 text-center">Trạng Thái</th></tr>
                  </thead>
                  <tbody class="text-xs font-bold">
                    @for (rec of declarationRecords(); track rec.id) {
                      <tr class="border-t border-black/5 hover:bg-white transition-all">
                        <td class="p-6">{{ rec.period }}</td>
                        <td class="p-6">{{ rec.type }}</td>
                        <td class="p-6 text-red-600">{{ rec.deadline }}</td>
                        <td class="p-6 text-right font-black">{{ rec.totalTax | number }}</td>
                        <td class="p-6 text-center">
                          <span class="px-3 py-1 rounded-full text-[8px] font-black uppercase"
                            [class.bg-green-500/10]="rec.status === 'Submitted'" [class.text-green-600]="rec.status === 'Submitted'"
                            [class.bg-gray-500/10]="rec.status === 'Draft'" [class.text-gray-600]="rec.status === 'Draft'">
                            {{ rec.status === 'Submitted' ? 'Đã Nộp' : 'Bản Nháp' }}
                          </span>
                        </td>
                      </tr>
                    }
                  </tbody>
                </table>
              </div>
            } @else {
              <div class="w-full max-w-4xl mx-auto py-4">
                <div class="flex justify-between mb-16 relative">
                  <div class="absolute top-1/2 left-0 w-full h-1 bg-black/5 -translate-y-1/2 -z-10"></div>
                  @for (step of [
                    {s:1, n:'Thiết lập'}, {s:2, n:'Bảng kê'}, {s:3, n:'Tờ khai'}, {s:4, n:'Hoàn tất'}
                  ]; track step.s) {
                    <div class="flex flex-col items-center gap-4 relative z-10">
                      <div [class]="declareStep() >= step.s ? 'bg-black text-white ring-4 ring-black/5' : 'bg-white text-black/20 border border-black/5'" class="w-12 h-12 rounded-full flex items-center justify-center font-black transition-all">
                        {{ step.s }}
                      </div>
                      <span class="text-[9px] font-black uppercase tracking-widest" [class.opacity-20]="declareStep() < step.s">{{ step.n }}</span>
                    </div>
                  }
                </div>

                @if (declareStep() === 1) { /* Omitted for brevity */ }
                @if (declareStep() === 2) { /* Omitted for brevity */ }
                @if (declareStep() === 3) { /* Omitted for brevity */ }

                @if (declareStep() === 4) {
                  <div class="animate-in space-y-12 bg-gray-50/50 p-16 rounded-[48px] border border-black/5">
                    <div>
                      <h3 class="text-3xl font-black uppercase mb-4 text-center">Bước 4: Kiểm tra & Hoàn tất</h3>
                      <p class="text-black/40 text-sm font-medium text-center">Hệ thống đã tự động đối soát dữ liệu. Vui lòng xem lại các cảnh báo trước khi nộp.</p>
                    </div>

                    <div class="space-y-4">
                      @for (w of declareValidation(); track w.title) {
                        <div class="p-6 border-l-4 rounded-2xl flex gap-4" [class.bg-yellow-500/10]="w.sev === 'warning'" [class.border-yellow-500]="w.sev === 'warning'" [class.bg-blue-500/10]="w.sev === 'info'" [class.border-blue-500]="w.sev === 'info'">
                          <span class="material-icons !text-3xl" [class.text-yellow-500]="w.sev === 'warning'" [class.text-blue-500]="w.sev === 'info'">{{ w.sev === 'warning' ? 'warning' : 'info' }}</span>
                          <div>
                            <p class="font-black text-sm">{{ w.title }}</p>
                            <p class="text-xs text-black/60">{{ w.desc }}</p>
                          </div>
                        </div>
                      }
                      @if (declareValidation().length === 0) {
                        <div class="p-6 bg-green-500/10 border-l-4 border-green-500 rounded-2xl flex items-center gap-4">
                            <span class="material-icons !text-3xl text-green-500">check_circle</span>
                            <div><p class="font-black text-sm">Dữ liệu hợp lệ! Tờ khai đã sẵn sàng để nộp.</p></div>
                        </div>
                      }
                    </div>

                    <div class="flex flex-col gap-6 max-w-md mx-auto">
                        <div class="grid grid-cols-3 gap-4">
                          <button (click)="exportFile('PDF')" class="w-full border-2 border-black/10 py-5 rounded-2xl font-black uppercase text-[10px] tracking-widest hover:bg-black hover:text-white transition-all flex flex-col items-center gap-2"><span class="material-icons">picture_as_pdf</span> PDF</button>
                          <button (click)="exportFile('XML')" class="w-full border-2 border-black/10 py-5 rounded-2xl font-black uppercase text-[10px] tracking-widest hover:bg-black hover:text-white transition-all flex flex-col items-center gap-2"><span class="material-icons">code</span> XML</button>
                          <button (click)="exportFile('Excel')" class="w-full border-2 border-black/10 py-5 rounded-2xl font-black uppercase text-[10px] tracking-widest hover:bg-black hover:text-white transition-all flex flex-col items-center gap-2"><span class="material-icons">receipt_long</span> Excel</button>
                        </div>
                      <button (click)="submitDeclaration()" class="w-full bg-green-600 text-white py-8 rounded-3xl font-black uppercase tracking-[0.2em] shadow-2xl hover:scale-[1.03] active:scale-95 transition-all">Ký Số và Nộp Tờ Khai</button>
                    </div>
                    <button (click)="declareStep.set(3)" class="text-[10px] font-black uppercase underline opacity-20 hover:opacity-100 transition-all">Sửa lại thông tin</button>
                  </div>
                }
              </div>
            }
          </div>
        }

        <!-- MODULE: SỔ KẾ TOÁN -->
        @if (activeTab() === 'accounting-book') { /* Omitted for brevity */ }

        <!-- MODULE: HÓA ĐƠN -->
        @if (activeTab() === 'invoices') { /* Omitted for brevity */ }

        <!-- MODULE: TÍNH THUẾ NHANH (NÂNG CẤP) -->
        @if (activeTab() === 'quick-calc') {
          <div class="animate-in bg-white rounded-[48px] shadow-2xl p-12">
            <h2 class="text-3xl font-black uppercase mb-10 tracking-tight text-black">Máy Tính Thuế Nhanh</h2>
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-12">
              <div class="space-y-8 p-8 bg-gray-50/50 rounded-[40px] border">
                  <div>
                    <h3 class="text-lg font-black uppercase tracking-tight mb-4">1. Ước tính Thuế GTGT</h3>
                    <div class="space-y-4">
                      <div><label class="text-[10px] font-black uppercase opacity-40">Doanh thu (Thuế suất 10%)</label><input type="number" [value]="quickCalcVatRevenues()['rev10']" (input)="updateQuickCalcVatRevenue('rev10', $event)" class="w-full bg-white p-3 rounded-xl font-black border mt-2"></div>
                      <div><label class="text-[10px] font-black uppercase opacity-40">Doanh thu (Thuế suất 5%)</label><input type="number" [value]="quickCalcVatRevenues()['rev5']" (input)="updateQuickCalcVatRevenue('rev5', $event)" class="w-full bg-white p-3 rounded-xl font-black border mt-2"></div>
                      <div><label class="text-[10px] font-black uppercase opacity-40">Doanh thu (Thuế suất 0%)</label><input type="number" [value]="quickCalcVatRevenues()['rev0']" (input)="updateQuickCalcVatRevenue('rev0', $event)" class="w-full bg-white p-3 rounded-xl font-black border mt-2"></div>
                    </div>
                  </div>
                  <div class="pt-8 border-t">
                    <h3 class="text-lg font-black uppercase tracking-tight mb-4">2. Ước tính Thuế TNCN</h3>
                     <div class="space-y-4">
                      <div><label class="text-[10px] font-black uppercase opacity-40">Tổng Doanh thu tính thuế TNCN</label><input type="number" [value]="quickCalcPitRevenue()" (input)="quickCalcPitRevenue.set(+$any($event.target).value)" class="w-full bg-white p-3 rounded-xl font-black border mt-2"></div>
                      <div><label class="text-[10px] font-black uppercase opacity-40">Tổng Chi phí hợp lý được trừ</label><input type="number" [value]="quickCalcPitExpense()" (input)="quickCalcPitExpense.set(+$any($event.target).value)" class="w-full bg-white p-3 rounded-xl font-black border mt-2"></div>
                    </div>
                  </div>
              </div>
              <div class="bg-black text-white p-12 rounded-[56px] flex flex-col justify-center shadow-3xl">
                 <div>
                    <h3 class="text-[12px] font-black uppercase tracking-[0.3em] opacity-30 mb-10">Kết quả ước tính</h3>
                    <div class="space-y-6">
                       <div class="flex justify-between items-center border-b border-white/10 pb-4"><span class="text-xs opacity-40 uppercase font-black">Thuế GTGT:</span><span class="text-3xl font-black">{{ quickCalcResult().vat | number }}</span></div>
                       <div class="flex justify-between items-center border-b border-white/10 pb-4"><span class="text-xs opacity-40 uppercase font-black">Thu nhập ròng:</span><span class="text-xl font-black">{{ quickCalcResult().netIncome | number }}</span></div>
                       <div class="flex justify-between items-center"><span class="text-xs opacity-40 uppercase font-black">Thuế TNCN:</span><span class="text-3xl font-black">{{ quickCalcResult().pit | number }}</span></div>
                    </div>
                 </div>
                 <div class="pt-10 mt-10 border-t border-white/10"><p class="text-[10px] font-black uppercase tracking-widest opacity-30 mb-2">Tổng thuế phải nộp</p><p class="text-6xl font-black text-[#97C2EC] leading-none">{{ quickCalcResult().totalTax | number }}</p></div>
              </div>
            </div>
          </div>
        }

        <!-- MODULE: VI PHẠM (PENALTY) -->
        @if (activeTab() === 'penalty') { /* Omitted for brevity */ }

        <!-- INTEGRATION WORKSPACES -->
        @if (activeTab() === 'integration-pos') { /* Omitted for brevity */ }
        @if (activeTab() === 'integration-sign') { /* Omitted for brevity */ }
        @if (activeTab() === 'integration-tax') { /* Omitted for brevity */ }

      </div>
      
      <footer class="w-full py-12 opacity-20 text-[10px] font-black uppercase tracking-[0.5em] text-center mt-auto shrink-0">
        Vietnam E-TAX HKD Solution • Standard 2026 • v2.4
      </footer>
    </main>
  </div>

  <!-- Chat Button & UI -->
  <button (click)="showChat.set(!showChat())" class="fixed bottom-8 right-8 w-16 h-16 bg-black text-[#97C2EC] rounded-full shadow-3xl z-50 flex items-center justify-center hover:scale-110 active:scale-95 transition-all">
    <span class="material-icons !text-3xl">{{ showChat() ? 'close' : 'chat' }}</span>
  </button>
  @if (showChat()) {
    <div class="fixed bottom-28 right-8 w-[350px] h-[550px] bg-white rounded-[40px] shadow-3xl z-50 overflow-hidden flex flex-col animate-in border border-black/5">
      <div class="p-6 bg-black text-white flex justify-between items-center"><div><h4 class="font-black text-sm uppercase tracking-widest">Trợ lý Thuế AI</h4></div><span class="material-icons text-[#97C2EC] animate-pulse">smart_toy</span></div>
      <div class="flex-1 p-4 overflow-y-auto space-y-4 bg-gray-50/50">
        @for (msg of chatMessages(); track msg.time) { <div [class]="msg.sender === 'ai' ? 'justify-start' : 'justify-end'" class="flex"> <div [class]="msg.sender === 'ai' ? 'bg-white text-black' : 'bg-black text-white'" class="max-w-[85%] p-4 rounded-2xl shadow-sm text-[11px] font-medium leading-relaxed">{{ msg.text }}</div> </div> }
      </div>
    </div>
  }
</div>
